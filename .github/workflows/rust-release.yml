name: Generate Rust Binaries and Create Release

on:
  push:
    tags:
      - 'v*'

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  packages: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-cross-platform:
    name: Build Linux & Windows
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            name: shortlinker-linux-x86_64
          - target: aarch64-unknown-linux-gnu
            name: shortlinker-linux-aarch64
          - target: i686-unknown-linux-gnu
            name: shortlinker-linux-i686
          - target: x86_64-pc-windows-gnu
            name: shortlinker-windows-x86_64.exe

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install cross
      run: cargo install cross --git https://github.com/cross-rs/cross

    - name: Build with cross
      run: cross build --release --target ${{ matrix.target }}

    - name: Rename binary
      run: |
        if [ "${{ matrix.target }}" = "x86_64-pc-windows-gnu" ]; then
          mv target/${{ matrix.target }}/release/shortlinker.exe ${{ matrix.name }}
        else
          mv target/${{ matrix.target }}/release/shortlinker ${{ matrix.name }}
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: ${{ matrix.name }}

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin
            name: shortlinker-macos-x86_64
          - target: aarch64-apple-darwin
            name: shortlinker-macos-aarch64

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Build native
      run: cargo build --release --target ${{ matrix.target }}

    - name: Rename binary
      run: mv target/${{ matrix.target }}/release/shortlinker ${{ matrix.name }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: ${{ matrix.name }}

  release:
    name: Create Release
    needs: [build-cross-platform, build-macos]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create release directory
      run: |
        mkdir -p release
        find artifacts -type f -exec cp {} release/ \;

    - name: Generate checksums
      run: |
        cd release
        sha256sum * > checksums.txt

    - name: Get tag name
      id: tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Get changelog
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREV_TAG" ]; then
          echo "Found previous tag: $PREV_TAG"
          
          # è·å–æäº¤ä¿¡æ¯å¹¶åˆ†ç±»
          COMMITS=$(git log --pretty=format:"%s|%h|%an" $PREV_TAG..HEAD --no-merges)
          
          # åˆå§‹åŒ–å„ç±»åˆ«
          FEATURES=""
          FIXES=""
          DOCS=""
          CHORES=""
          OTHERS=""
          
          # å¤„ç†æ¯ä¸ªæäº¤
          while IFS='|' read -r message hash author; do
            # è·³è¿‡ç©ºè¡Œ
            [ -z "$message" ] && continue
            
            # æ ¹æ® conventional commits åˆ†ç±»
            case "$message" in
              feat*|feature*)
                FEATURES="$FEATURES\n- $message ([$hash](https://github.com/${{ github.repository }}/commit/$hash))"
                ;;
              fix*|bugfix*)
                FIXES="$FIXES\n- $message ([$hash](https://github.com/${{ github.repository }}/commit/$hash))"
                ;;
              docs*)
                DOCS="$DOCS\n- $message ([$hash](https://github.com/${{ github.repository }}/commit/$hash))"
                ;;
              chore*|build*|ci*|style*|refactor*|perf*|test*)
                CHORES="$CHORES\n- $message ([$hash](https://github.com/${{ github.repository }}/commit/$hash))"
                ;;
              *)
                OTHERS="$OTHERS\n- $message ([$hash](https://github.com/${{ github.repository }}/commit/$hash))"
                ;;
            esac
          done <<< "$COMMITS"
          
          # æ„å»º changelog
          CHANGELOG=""
          
          if [ -n "$FEATURES" ]; then
            CHANGELOG="$CHANGELOG### ğŸš€ æ–°åŠŸèƒ½\n$FEATURES\n\n"
          fi
          
          if [ -n "$FIXES" ]; then
            CHANGELOG="$CHANGELOG### ğŸ› Bug ä¿®å¤\n$FIXES\n\n"
          fi
          
          if [ -n "$DOCS" ]; then
            CHANGELOG="$CHANGELOG### ğŸ“š æ–‡æ¡£æ›´æ–°\n$DOCS\n\n"
          fi
          
          if [ -n "$OTHERS" ]; then
            CHANGELOG="$CHANGELOG### ğŸ”„ å…¶ä»–æ”¹è¿›\n$OTHERS\n\n"
          fi
          
          if [ -n "$CHORES" ]; then
            CHANGELOG="$CHANGELOG### ğŸ› ï¸ å¼€å‘ç›¸å…³\n$CHORES\n\n"
          fi
          
          # å¦‚æœæ²¡æœ‰åˆ†ç±»çš„æäº¤ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="### ğŸ”„ æ›´æ–°å†…å®¹\n\næœ¬æ¬¡æ›´æ–°åŒ…å«å¤šé¡¹æ”¹è¿›å’Œä¼˜åŒ–ã€‚"
          fi
          
          # æ·»åŠ æ¯”è¾ƒé“¾æ¥
          CHANGELOG="$CHANGELOG---\n\n**å®Œæ•´æ›´æ”¹**: [$PREV_TAG...${{ steps.tag.outputs.tag }}](https://github.com/${{ github.repository }}/compare/$PREV_TAG...${{ steps.tag.outputs.tag }})"
          
        else
          echo "No previous tag found, this is the initial release"
          CHANGELOG="### ğŸ‰ é¦–æ¬¡å‘å¸ƒ\n\nè¿™æ˜¯ Shortlinker çš„é¦–ä¸ªæ­£å¼ç‰ˆæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š\n\n- âš¡ é«˜æ€§èƒ½çš„çŸ­é“¾æ¥é‡å®šå‘æœåŠ¡\n- ğŸ› ï¸ å®Œæ•´çš„å‘½ä»¤è¡Œç®¡ç†å·¥å…·\n- ğŸ³ Docker å®¹å™¨åŒ–æ”¯æŒ\n- ğŸ“± è·¨å¹³å°å…¼å®¹ï¼ˆLinuxã€macOSã€Windowsï¼‰\n- ğŸ”§ ç®€å•æ˜“ç”¨çš„é…ç½®ç®¡ç†\n- ğŸ“Š JSON æ–‡ä»¶å­˜å‚¨ï¼Œæ”¯æŒçƒ­é‡è½½"
        fi
        
        # è¾“å‡ºåˆ° GitHub Actions
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # è°ƒè¯•è¾“å‡º
        echo "Generated changelog:"
        echo -e "$CHANGELOG"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: Release ${{ steps.tag.outputs.tag }}
        body: |
          <div align="center">
          
          # ğŸš€ ShortLinker ${{ steps.tag.outputs.tag }}

          <p>
            <a href="https://github.com/AptS-1547/shortlinker/releases/tag/${{ steps.tag.outputs.tag }}">
              <img src="https://img.shields.io/github/downloads/AptS-1547/shortlinker/${{ steps.tag.outputs.tag }}/total?style=for-the-badge&amp;color=blue" alt="Downloads">
            </a>
            <a href="LICENSE">
              <img src="https://img.shields.io/github/license/AptS-1547/shortlinker?style=for-the-badge" alt="License">
            </a>
            <a href="https://github.com/AptS-1547/shortlinker/actions">
              <img src="https://img.shields.io/github/actions/workflow/status/AptS-1547/shortlinker/rust-release.yml?style=for-the-badge" alt="Build Status">
            </a>
          </p>

          **é«˜æ€§èƒ½çš„é“¾æ¥ç¼©çŸ­æœåŠ¡ï¼Œä½¿ç”¨ Rust æ„å»º** âš¡
          
          </div>
          
          ---
          
          ## âœ¨ æ–°ç‰¹æ€§ & æ”¹è¿›
          
          ${{ steps.changelog.outputs.changelog }}
          
          ---
          
          ## ğŸ“¦ å¿«é€Ÿä¸‹è½½
          
          > ğŸ’¡ **æç¤º**ï¼šé€‰æ‹©ä¸æ‚¨ç³»ç»ŸåŒ¹é…çš„ç‰ˆæœ¬ï¼Œä¸‹è½½åå¯ç›´æ¥è¿è¡Œï¼
          
          <table>
          <tr>
          <td align="center"><img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/linux/linux-original.svg" width="32" height="32"><br><b>Linux</b></td>
          <td align="center"><img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/windows8/windows8-original.svg" width="32" height="32"><br><b>Windows</b></td>
          <td align="center"><img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/apple/apple-original.svg" width="32" height="32"><br><b>macOS</b></td>
          </tr>
          <tr>
          <td>
          
          **x86_64** (Intel/AMD 64ä½)  
          ğŸ“¥ [shortlinker-linux-x86_64](https://github.com/AptS-1547/shortlinker/releases/download/${{ steps.tag.outputs.tag }}/shortlinker-linux-x86_64)
          
          **ARM64** (æ ‘è“æ´¾4/æœåŠ¡å™¨)  
          ğŸ“¥ [shortlinker-linux-aarch64](https://github.com/AptS-1547/shortlinker/releases/download/${{ steps.tag.outputs.tag }}/shortlinker-linux-aarch64)
          
          **i686** (32ä½è€è®¾å¤‡)  
          ğŸ“¥ [shortlinker-linux-i686](https://github.com/AptS-1547/shortlinker/releases/download/${{ steps.tag.outputs.tag }}/shortlinker-linux-i686)
          
          </td>
          <td>
          
          **x86_64** (64ä½ Windows)  
          ğŸ“¥ [shortlinker-windows-x86_64.exe](https://github.com/AptS-1547/shortlinker/releases/download/${{ steps.tag.outputs.tag }}/shortlinker-windows-x86_64.exe)
          
          <br><br><br><br>
          
          </td>
          <td>
          
          **Intel** (Intel Mac)  
          ğŸ“¥ [shortlinker-macos-x86_64](https://github.com/AptS-1547/shortlinker/releases/download/${{ steps.tag.outputs.tag }}/shortlinker-macos-x86_64)
          
          **Apple Silicon** (M1/M2/M3)  
          ğŸ“¥ [shortlinker-macos-aarch64](https://github.com/AptS-1547/shortlinker/releases/download/${{ steps.tag.outputs.tag }}/shortlinker-macos-aarch64)
          
          <br><br>
          
          </td>
          </tr>
          </table>
          
          ---
          
          ## ğŸš€ å¿«é€Ÿå¼€å§‹
          
          ### Linux / macOS
          ```bash
          # ä¸‹è½½å¹¶èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x shortlinker-*
          
          # ç›´æ¥è¿è¡Œ
          ./shortlinker-*
          ```
          
          ### Windows
          ```powershell
          # ç›´æ¥åŒå‡»è¿è¡Œæˆ–åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ
          .\shortlinker-windows-x86_64.exe
          ```
          
          ---
          
          ## ğŸ” å®‰å…¨éªŒè¯
          
          ä¸ºç¡®ä¿ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ï¼Œè¯·éªŒè¯ SHA256 æ ¡éªŒå’Œï¼š
          
          ```bash
          # ä¸‹è½½æ ¡éªŒæ–‡ä»¶
          curl -LO https://github.com/AptS-1547/shortlinker/releases/download/${{ steps.tag.outputs.tag }}/checksums.txt
          
          # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
          sha256sum -c checksums.txt
          
          # æˆ–å•ç‹¬éªŒè¯æŸä¸ªæ–‡ä»¶
          sha256sum shortlinker-linux-x86_64
          ```
          
          ğŸ“‹ **æ ¡éªŒæ–‡ä»¶ä¸‹è½½**ï¼š[checksums.txt](https://github.com/AptS-1547/shortlinker/releases/download/${{ steps.tag.outputs.tag }}/checksums.txt)
          
          ---
          
          ## ğŸ“– æ–‡æ¡£ & å¸®åŠ©
          
          | èµ„æº | é“¾æ¥ | æè¿° |
          |------|------|------|
          | ğŸ“š **å®Œæ•´æ–‡æ¡£** | [esap.cc/docs](https://esap.cc/docs) | è¯¦ç»†ä½¿ç”¨æŒ‡å—å’ŒAPIæ–‡æ¡£ |
          | ğŸ› **é—®é¢˜åé¦ˆ** | [Issues](https://github.com/AptS-1547/shortlinker/issues) | æŠ¥å‘Šbugæˆ–æå‡ºåŠŸèƒ½è¯·æ±‚ |
          | ğŸ’¬ **è®¨è®ºåŒº** | [Discussions](https://github.com/AptS-1547/shortlinker/discussions) | ç¤¾åŒºäº¤æµå’Œé—®ç­” |
          | ğŸ”§ **è´¡çŒ®æŒ‡å—** | [CONTRIBUTING.md](CONTRIBUTING.md) | å‚ä¸é¡¹ç›®å¼€å‘ |
          
          ---
          
          ## ğŸ¯ ä¸»è¦ç‰¹æ€§
          
          - âš¡ **é«˜æ€§èƒ½**ï¼šåŸºäº Rustï¼Œå†…å­˜å®‰å…¨ä¸”æé€Ÿå“åº”
          - ğŸ›¡ï¸ **å®‰å…¨å¯é **ï¼šå†…ç½®é˜²æŠ¤æœºåˆ¶ï¼Œæ•°æ®åŠ å¯†å­˜å‚¨
          - ğŸŒ **è·¨å¹³å°**ï¼šæ”¯æŒ Linuxã€Windowsã€macOS å¤šå¹³å°
          - ğŸ“Š **å®æ—¶ç»Ÿè®¡**ï¼šç‚¹å‡»ç»Ÿè®¡ã€è®¿é—®åˆ†æç­‰åŠŸèƒ½
          - ğŸ”§ **æ˜“äºéƒ¨ç½²**ï¼šå•æ–‡ä»¶éƒ¨ç½²ï¼Œé…ç½®ç®€å•
          - ğŸ“± **ç°ä»£åŒ–UI**ï¼šå“åº”å¼è®¾è®¡ï¼Œç§»åŠ¨ç«¯å‹å¥½
          
          ---
          
          ## ğŸ’ æ”¯æŒé¡¹ç›®
          
          å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·è€ƒè™‘ï¼š
          
          - â­ **ç»™é¡¹ç›®ç‚¹æ˜Ÿ**
          - ğŸ› **æŠ¥å‘Šé—®é¢˜**
          - ğŸ”§ **æäº¤PR**
          - ğŸ“¢ **åˆ†äº«ç»™æœ‹å‹**
          
          ---
          
          <div align="center">
          
          **æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…å’Œç”¨æˆ·çš„æ”¯æŒï¼** â¤ï¸
          <p>
            <img src="https://img.shields.io/github/contributors/AptS-1547/shortlinker?style=for-the-badge" alt="Contributors">
            <img src="https://img.shields.io/github/stars/AptS-1547/shortlinker?style=for-the-badge" alt="Stars">
            <img src="https://img.shields.io/github/forks/AptS-1547/shortlinker?style=for-the-badge" alt="Forks">
          </p>
          </div>

        files: |
          release/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}