# Shortlinker Configuration File
# ================================
#
# This file contains startup configuration that requires a restart to take effect.
# Runtime settings (API, routes, features, CORS) are stored in the database
# and can be modified via the Admin Panel without restarting.
#
# Usage:
#   1. Copy this file to config.toml
#   2. Modify settings as needed
#   3. Start the server
#
# Security Notes:
# - Login rate limiting uses smart proxy detection: when api.trusted_proxies is not
#   configured and connections come from private IPs (Docker/nginx), X-Forwarded-For
#   headers are automatically trusted. This works for most reverse proxy setups.
# - For precise control, configure api.trusted_proxies in Admin Panel (supports IP and CIDR).
#   Example: Docker deployments can use ["172.16.0.0/12"], nginx can use the proxy server IP.
# - IPC socket permissions are restricted to 0600 (owner access only).

# ==============================================================================
# Server Configuration
# ==============================================================================
[server]
# Server bind address
# Use "0.0.0.0" to listen on all interfaces
host = "127.0.0.1"

# Server port
port = 8080

# Unix socket path (optional)
# If set, overrides host and port settings
# Useful for nginx reverse proxy with socket connection
# unix_socket = "/tmp/shortlinker.sock"

# Number of worker threads (optional)
# Defaults to the number of logical CPU cores
# cpu_count = 4

# ==============================================================================
# Database Configuration
# ==============================================================================
[database]
# Database connection URL or file path
# Type is auto-detected from URL scheme:
#   - sqlite:// or .db/.sqlite file -> SQLite
#   - postgres:// or postgresql://  -> PostgreSQL
#   - mysql://                       -> MySQL
#   - mariadb://                     -> MariaDB (uses MySQL protocol)
#
# Examples:
#   SQLite:     "shortlinks.db" or "sqlite:///path/to/db.sqlite"
#   PostgreSQL: "postgres://user:pass@localhost:5432/shortlinker"
#   MySQL:      "mysql://user:pass@localhost:3306/shortlinker"
database_url = "shortlinks.db"

# Connection pool size
# Increase for high-traffic deployments
pool_size = 10

# Connection timeout in seconds
timeout = 30

# Retry configuration for transient database errors
# Number of retry attempts before failing
# retry_count = 3

# Initial delay between retries in milliseconds
# retry_base_delay_ms = 100

# Maximum delay between retries in milliseconds (exponential backoff cap)
# retry_max_delay_ms = 2000

# ==============================================================================
# Cache Configuration
# ==============================================================================
[cache]
# Cache backend type: "memory" or "redis"
# - memory: Fast in-process cache using Moka, suitable for single-instance deployments
# - redis:  Distributed cache, required for multi-instance deployments
type = "memory"

# Default cache TTL in seconds
# How long cached entries remain valid
default_ttl = 3600

# Redis configuration (used when type = "redis")
[cache.redis]
# Redis connection URL
# Format: redis://[username:password@]host[:port][/database]
url = "redis://127.0.0.1:6379/"

# Key prefix for all cached entries
# Useful when sharing Redis with other applications
key_prefix = "shortlinker:"

# Memory cache configuration (used when type = "memory")
[cache.memory]
# Maximum number of entries in cache
# Older entries are evicted when limit is reached (LRU policy)
max_capacity = 10000

# ==============================================================================
# Logging Configuration
# ==============================================================================
[logging]
# Log level: trace, debug, info, warn, error
# - trace: Most verbose, includes all details
# - debug: Detailed information for debugging
# - info:  General operational messages (recommended for production)
# - warn:  Warning messages for potential issues
# - error: Only error messages
level = "info"

# Output format: "text" or "json"
# - text: Human-readable format for console/development
# - json: Structured format for log aggregation systems (ELK, Loki, etc.)
format = "text"

# Log file path (optional)
# If not set, logs are written to stdout/stderr
# file = "shortlinker.log"

# Maximum log file size in MB before rotation
max_size = 100

# Number of rotated log files to keep
max_backups = 5

# Enable log file rotation
# When disabled, logs append to a single file indefinitely
enable_rotation = true

# ==============================================================================
# Analytics Configuration
# ==============================================================================
[analytics]
# MaxMindDB file path for local IP geolocation (optional)
# Download GeoLite2-City.mmdb from MaxMind (free registration required)
# If configured and file is readable, uses local parsing for better performance
# Otherwise falls back to external GeoIP API
# maxminddb_path = "/path/to/GeoLite2-City.mmdb"

# External GeoIP API URL (fallback when MaxMindDB is not available)
# Use {ip} as placeholder for the IP address
# Default uses ip-api.com free tier (limited to 45 requests/minute)
geoip_api_url = "http://ip-api.com/json/{ip}?fields=countryCode,city"
